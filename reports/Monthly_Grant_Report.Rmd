---
date: "`r format(Sys.time(), '%d %B, %Y')`"
title:  "PHSU-MCC Monthly Grant Report"
author: ""
output: 
  officedown::rdocx_document:
    # NB: R execution does not seem supported here, so include path 
    # relative to markdown document (typically in reports/ vs templates/).
    reference_docx: "../templates/u54_docx.docx"
    page_margins:
      bottom: 0.5
      top: 0.5
      right: 0.5
      left: 0.5
      header: 0.5
      footer: 0.5
      gutter: 0
    page_size:
      width: 8.5
      height: 11
      orient: "portrait"

knit: pgreportr::knit_docx_with_datestamp

# Markdown parameters. You can specify a REDCap export
# file (.r or .csv pair) or a
# URL for importing from a REDCap server live.
#
# The start/end date are self-explanatory for report.
params:
  uri: "https://redcap.psm.edu/api/"
  redcap_data: "PartnershipTrackingG_R_2022-02-01_1542.r"
  end_date: "2022-02-21"
  use_cache: TRUE
---
                            

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE)
library(officedown)
library(officer)
library(dplyr)
library(pgreportr)
library(ggplot2)

redcap_version_date <- lubridate::today()

# Current Partnership Grant reporting year
pg_yr<-pgreportr::convert_date_to_pg_year(params$end_date)
start_date <- pgreportr::pg_start_date(pg_yr)


```

---
subtitle: "`r start_date` to `r params$end_date`"
---

REDCap data version: `r redcap_version_date`

<!---BLOCK_TOC--->

\newpage






```{r load-redcap}

if ( params$use_cache ) {
  grants <- readRDS(here::here("data","cached_grants.rds"))
} else {
  # NOTE:
  # If you have not stored the key yet, use the following command at the R prompt to store it.
  #
  # keyring::key_set("pgreportr-REDCap-Grants-API-token", username = NULL, prompt = "REDCap API Grants Token: ")
  #
  # Get API key
  token <- keyring::key_get("pgreportr-REDCap-Grants-API-token", NULL)
  suppressMessages(
    grants <- pgreportr::import_grants(params$uri, token)
  )
  saveRDS(grants, here::here("data","cached_grants.rds"))
}
```


```{r create-initial-tables}

grants <- grants %>%
  dplyr::arrange(`Submission Date`)


grants_submitted<-grants %>%
  pgreportr::filter_grants_submitted_between(
    start = pgreportr::pg_start_date(pg_yr), 
    end = params$end_date
  )

grants_funded<-grants %>%
  pgreportr::filter_grants_funded_between(
    start = pgreportr::pg_start_date(pg_yr),
    end = params$end_date) %>%
  dplyr::arrange(`Funding Start Date`)

grants_pending<-grants %>%
  pgreportr::filter_grants_pending_review()

```

```{r build-summary-table}


# The goal of this tibble is:
# tag: Easy name to refer to row
# Description: Header text
# Count: Number of category
# Data: Tibble of grants meeting the category criteria
# Detail: Long text with in-depth description of the way in which the table is derived.
summary_table<-tibble::tribble(
    ~tag, ~Description, ~Data,~Detail,
  "submissions",
  glue::glue("{pg_yr} Grant Submissions"), 
  grants_submitted,
"
The total number of grants with Submission Date in the range of {start_date} to {params$end_date} are listed.
",
  
  "esi-related submissions",
  glue::glue("{pg_yr} ESI-Related Grants Submitted"), 
  grants_submitted %>% filter_grants_esi_related(),
"
The total number of grants submitted in the range of {start_date} to {params$end_date} that are
identified as ESI-Related. ESI-Related is defined as a grant for which an ESI member is listed (not
necessarily PI, etc).
",
  
  # NOTE: This is a repeated table since ESI-mentions are the same grants
  # as ESI-related. There is an override below for the counts.
  "num esi-related mentions",
  glue::glue("Number of times an ESI was involved in a {pg_yr} submission"),
  grants_submitted %>% pgreportr::filter_grants_esi_related(),
"
The total number of times an ESI was involved in a grant submitted in the range of {start_date} to {params$end_date}. Each participant of a grant submission is counted if the participant is an ESI.
The same ESI may be counted multiple times as a member of distinct grant submissions.
",
  
  
  "submissions not funded",
  glue::glue("Grants Not Funded in {pg_yr}"), 
   grants_submitted %>% pgreportr::filter_grants_not_funded(),
"
The total number of grants submitted in the range of {start_date} to {params$end_date} that were subsequently not funded. Note this is not the number of grants that were determined to be Not Funded within the date range, but rather the number of submissions during the period that were at some point determined Not Funded.
",
  
  "grants funded",
  glue::glue("Grants Funded in {pg_yr}"), 
  grants_funded,
"
The number of grants that were funded (awarded) between {start_date} to {params$end_date}.
Note this is determined by the annotated project start date.
",
    
  "esi grants funded",
  glue::glue("ESI-related Grants Funded in {pg_yr}"), 
  grants_funded %>% pgreportr::filter_grants_esi_related(),
"
The number of grants funded between {start_date} to {params$end_date} which are ESI-related,
meaning that a ESI is named within the grant.
",
  
  "submissions pending",
  "Submissions Pending Review",
  grants_pending,
"
The number of grant submissions that are currently pending review. That is, grants that are 
submitted but no final decision has been determined. Given the time window of the
report (e.g., the start of the fiscal year), there may be no grants pending review. Note that
for consistency, any grants pending review are listed. This includes grants outside of the
report range (before or after), so this number may disagree with grants submitted in a time range.
",
  
  "esi submissions pending",
"ESI-Related Grant Submissions Pending Review", 
  grants_pending %>% pgreportr::filter_grants_esi_related(),
"
Total number of grant submissions that are currently pending review and that involve an ESI within 
the grant. 
"  ) %>%
    dplyr::mutate(
    `Count` = ifelse(tag =="num esi-related mentions",
                     purrr::map_int(Data, pgreportr::count_esi_mentions_in_grant),
                     purrr::map_int(Data, nrow)
    ),
    `Count` = tidyr::replace_na(`Count`, 0)

  )
  
```

```{r dashboard-cards, fig.height=1.5, fig.width=7.25}

info_box <- function(title="Submitted", content="21", fill="blue", col="white") {

  ggplot(data.frame(x=c(0,1), y=c(0,1)), aes(x=x,y=y)) +
    theme_void() +
    ggtext::geom_textbox(
      label = glue::glue(
        "<br><span style = 'font-size:16pt'>{title}</span><br><br><span style = 'font-size:48pt'>{content}</span>"
      ), 
      x=0.5,y=0.5,
      width=1, height=1, 
      fill=fill,col=col,
      box.r=unit(0,"npc"),
      #size=30,
      valign=0.5, halign=0.5
    ) 
}

grant_status_color <- c("submissions"="#34789a","grants funded"="#5ea54b","submissions pending"="#edab18","submissions not funded"="#FF0800")
grant_status_color_palette <- function(tag) grant_status_color[tag]

grant_card_list <- list(
  info_box(dplyr::filter(summary_table, tag=="submissions") %>% dplyr::pull("Description"),
            dplyr::filter(summary_table, tag=="submissions") %>% dplyr::pull("Count"), 
           fill=grant_status_color["submissions"],col="white"),
  info_box(dplyr::filter(summary_table, tag=="grants funded") %>% dplyr::pull("Description"), 
           dplyr::filter(summary_table, tag=="grants funded") %>% dplyr::pull("Count"), 
           fill=grant_status_color["grants funded"], col = "white"),
  info_box(dplyr::filter(summary_table, tag=="submissions not funded") %>% dplyr::pull("Description"), 
           dplyr::filter(summary_table, tag=="submissions not funded") %>% dplyr::pull("Count"), 
           fill=grant_status_color["submissions not funded"], col="white"),
  info_box(dplyr::filter(summary_table, tag=="submissions pending") %>% dplyr::pull("Description"), 
           dplyr::filter(summary_table, tag=="submissions pending") %>% dplyr::pull("Count"), 
           fill=grant_status_color["submissions pending"], col="black")
)

  
```

```{r dashboard-barplot, fig.width=7.25, fig.height=6}
ptable <- summary_table %>%
  dplyr::slice(
    rev(match(c("submissions","grants funded", "submissions pending","submissions not funded"), summary_table$tag))
  ) %>%
  dplyr::mutate(Description =stringr::str_wrap(Description, 15)) %>%
  dplyr::mutate(Description = factor(Description, levels = Description))


grant_bar_chart <- ggpubr::ggbarplot(ptable, x = "Count",y="Description", ylab = "",
                  palette = grant_status_color, 
                  fill = "tag",
                  sort.val ="none", width=0.9,
                  label = ptable$Count,
                  lab.size = 7, lab.hjust=-1, lab.vjust=0.2) +
  theme(legend.position = "none",
        axis.text=element_text(size=8)) +xlim(c(0,ceiling(max(ptable$Count)+0.2*max(ptable$Count))))


plot_piechart <- function(df, main="", show_legend=FALSE) {
  p <- ggplot(df, aes(x=1, y=value, fill=label)) + 
    geom_col() + 
    coord_polar(theta="y") +
    geom_text(
      aes(label = value),
      position = position_stack(vjust = 0.5),
      size=8
    ) + 
    theme_void() +
    scale_fill_brewer() +
    xlab("") + ylab("") +
    theme(legend.title = element_blank()) +
    ggtitle(main) +
    xlim(c(-0.5,1.5)) 

  if ( !show_legend) p <- p + theme(legend.position="none")
  
  p
   
}

make_pie_df <- function(.x, all, esi) {
  pl <- .x %>%
    dplyr::filter(tag %in% c(all, esi)) %>%
    dplyr::select(tag, Count) %>%
    tibble::deframe()
  
  tibble::tribble(
    ~label, ~value,
    "Non-ESI Related", pl[all]-pl[esi],
    "ESI Related", pl[esi] 
  )
}

grant_piechart_list <- list(
  plot_piechart(make_pie_df(summary_table, "submissions", "esi-related submissions"), main="Submissions"),
  plot_piechart(make_pie_df(summary_table, "submissions pending", "esi submissions pending"), main="Pending"),
  plot_piechart(make_pie_df(summary_table, "grants funded","esi grants funded"), main="Funded"),
  cowplot::get_legend(plot_piechart(make_pie_df(summary_table, "grants funded","esi grants funded"), main="Funded",show_legend=TRUE))

)

# Complicated dashboard
# Top is the cards (full width)
# Bottom left is the barplot
# Bottom right are the pie charts
cowplot::plot_grid(
  nrow = 2, ncol = 1, rel_heights = c(1,3),
  cowplot::plot_grid(nrow=1, plotlist = grant_card_list),
  cowplot::plot_grid(
    nrow = 1, ncol = 2, rel_widths = c(2,3),
    grant_bar_chart, 
    cowplot::plot_grid(
      nrow = 2, ncol = 2,
      plotlist = grant_piechart_list
    )
  )
)

```

\newpage
# Overview

The purpose of this report is to list and count U54-related grants submitted, funded, and pending within the U54 grant year `r pg_yr` (`r start_date` - 
`r params$end_date`). The list below indicates the specific criteria used to define each category that is counted and listed. Please refer to Table \@ref(tab:summarytable) for details on the definition of specific terms used within the criteria.

Table \@ref(tab:summarytable) shows the summary of grant categories provided in this report. For each category, a brief 
description is provided along with the count of number of matching grants. An extended description,
including some of the logic associated with the filtering, is provided as well.

\newpage
```{r summary-table, tab.cap = "Summary of reported grant categories.", tab.id="summarytable"}
summary_table %>%
  dplyr::select(Description, Count, Detail) %>%
  dplyr::mutate(Detail =  
                  stringr::str_replace_all(
                    purrr::map_chr(Detail, glue::glue), "\n"," ")) %>%
  flextable::flextable() %>%
  flextable::width(width=c(1.5,0.8,5)) %>%
  flextable::align(j=2, align="right") %>%
  flextable::bg(bg="#4F81BD", part="header") %>%
  flextable::color(color="#FFFFFF", part="header") 


```

\newpage








# Individual Grant Reports

All grant categories are provided below, with a detailed list of each grant that matches the category.

```{r generate-individual-reports, results='asis'}
# Output a flextable per row of the summary.
summary_table %>%
  dplyr::rowwise() %>%
  purrr::pwalk(function(tag, Description, Data, Detail, Count, header) {
    cat("## ", Description, ": ", Count, "\n\n")
    cat(glue::glue(Detail), "\n\n")
    flextable::flextable_to_rmd(
      pgreportr::style_grants_as_flextable_gamma(Data),
      bookdown=TRUE
    )
    cat("\\newpage")
  })

```

```{r eval=FALSE}
print(doc, target = sprintf("Monthly_Report_%s_%s_%s.docx",
                            reporting_month, 
                            reporting_year,
                            format(Sys.time(), '%Y%m%d')))
```


# Excel Summary Output

The raw data for this grant report is also exported to an Excel file :

```{r define-excel-filename, format='asis'}
excel_filename <- here::here(
  "delivery",
  glue::glue("Monthly_Grant_Tracking_Tables_{lubridate::today()}.xlsx")
)

officer::ftext(basename(excel_filename), officer::fp_text(font.family="Courier New"))
```

This file can be used to verify the numbers or for further analysis. Note that the Excel 
output is in "raw" form, in which indicator variables are included for each condition (e.g., `is_grant_funded`).

```{r write-xls, eval=TRUE}
xls_table <- summary_table %>%
  dplyr::rowwise() %>%
  dplyr::mutate(text_output =  
                  list(pgreportr::style_grants_as_text_alpha(Data))) %>%
  dplyr::select(tag, text_output) %>%
  tibble::deframe() %>%
  writexl::write_xlsx(path = excel_filename)
```


